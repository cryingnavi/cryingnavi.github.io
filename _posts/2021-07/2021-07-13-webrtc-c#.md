---
layout: post
title: Window용 WebRTC 앱 만들기
date: "2021-07-13 10:22"
categories: webrtc
tags: [webrtc, turn, C#]
published: false
---


## 개요
샘플용 UWP 어플리케이션을 제작함으로써 MixedReality-WebRTC를 이용해 어떻게 WebRTC 서비스를 구현할 수 있는지 단계별로 알아보도록 하겠습니다. 아래 단계를 모두 거치면, UWP 데스크탑 앱과 다른 피씨 또는 모바일 브라우저와 WebRTC로 화상 통신을 연결할 수 있을 것입니다.  

또한, 시그널 서버는 자체 구현한 시그널 서버를 사용할 것입니다. 해당 시그널 서버는 https://github.com/cryingnavi/webrtc-server를 참조하시면 됩니다. 해당 서버를 구동하는 방법과 통신 방법은 별도로 설명하겠습니다.

UWP가 무엇인지에 대하 자세히 알고 싶다면, https://docs.microsoft.com/ko-kr/windows/uwp/get-started/universal-application-platform-guide?OCID=VSClient_Ver17_UWPOverview_what-is-uwp를 참조하면 됩니다.


## 프로젝트 생성하기
유니버셜 프로젝트를 생성합니다. 저는 WebRTCEx02라는 이름으로 프로젝트를 생성했습니다. 
![프로젝트 생성하기](/assets/images/2021-07-12/webrtc01.png)
![프로젝트 생성하기](/assets/images/2021-07-12/webrtc02.png)

## MixedReality-WebRTC에 종속성 추가하기
MixedReality-WebRTC 종속성을 추가하기 위해서는 NuGet 패키지 도구를 이용합니다. NuGet은 Visual Studio에서 사용되는 무료 또는 오픈 소스 패키지를 관리해주는 도구로 GUI 환경에서 이를 다운로드 하고 관리할 수 있습니다.  
MixedReality-WebRTC는 NuGet을 이용해 종속성을 추가합니다. 

![종속성추가](/assets/images/2021-07-10/webrtc04.png)
![종속성추가](/assets/images/2021-07-12/webrtc03.png)

위와 같이 Microsoft.MixedReality.WebRTC를 검색해서 설치 합니다. 이번에는 반드시 Microsoft.MixedReality.WebRTC.UWP를 설치해야 합니다.

## 레이아웃 생성하기
MainPage.xaml 파일을 열고 아래와 같이 xml을 작성합니다.

```
<Page
    x:Class="WebRTCEX02.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:WebRTCEX02"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}" d:DesignWidth="3833.333" d:DesignHeight="2231.481">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="5*"/>
            <ColumnDefinition Width="5*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="5*"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Grid.Column="0" Background="#000"/>
        <Border Grid.Row="0" Grid.Column="1" Background="gray"/>

        <StackPanel Grid.Row="0" Grid.Column="0" Margin="20" VerticalAlignment="Center">
            <!-- 로컬 비디오 표시 -->
        </StackPanel>
        <StackPanel Grid.Row="0" Grid.Column="1" Margin="20" VerticalAlignment="Center">
            <!-- 리모트 비디오 표시 -->
        </StackPanel>
        <StackPanel Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal"
            HorizontalAlignment="Center" VerticalAlignment="Center">
            <TextBox Width="500" PlaceholderText="채팅방 아이디를 입력하세요"/>
        </StackPanel>

        <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Orientation="Horizontal"
            HorizontalAlignment="Center" VerticalAlignment="Center">
            <Button Content="Start" Margin="10" />
            <Button Content="Call" Margin="10" />
            <Button Content="HangUp" Margin="10" />
        </StackPanel>
    </Grid>
</Page>
```

그럼 아래와 같은 레이아웃이 생성 될 것입니다. 검은색 바탕은 로컬 비디오가 표현될 공간이고 회색 바탕은 리모트 비디오가 표현될 공간입니다.

![레이아웃](/assets/images/2021-07-12/webrtc04.png)

## 권한 허용하기
WebRTC 어플리케이션은 웹캠, 마이크, 인터넷 액세스에 대한 권한을 가지고 있어야 합니다. 웹캠과 마이크는 당연히 장치에 접근해야하기 때문이고 인터넷은 다른 피어와 연결해야하기 때문에 권한 허용이 필요한 부분입니다.

![레이아웃](/assets/images/2021-07-12/webrtc05.png)
![레이아웃](/assets/images/2021-07-12/webrtc06.png)


## 로컬 비디오 표현하기
하단에 버튼이 있습니다. 지금은 버튼들은 무시하고 일단 검은색 바탕화면 부분에 로컬 비디오를 표시해 보겠습니다.

로컬 비디오를 표시하기 위해서는 VideoBridge라는 유틸리티가 필요합니다. 이는 캡처한 비디오 프레임을 수집해서 표시하는 역할을 수행합니다. 또한 VideoBridge는 StreamSamplePool 클래스를 사용합니다. 두 개의 소스는 각각 
https://github.com/microsoft/MixedReality-WebRTC/blob/master/examples/TestAppUwp/Video/VideoBridge.cs 와 https://github.com/microsoft/MixedReality-WebRTC/blob/master/examples/TestAppUwp/Video/StreamSamplePool.cs 에서 얻을 수 있습니다.

두개의 소스를 가져와 프로젝트에 포함 시킵니다.